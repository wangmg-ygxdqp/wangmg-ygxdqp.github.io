<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wmg的个人主页</title>
  
  
  <link href="https://wangmg-ygxdqp.github.io/atom.xml" rel="self"/>
  
  <link href="https://wangmg-ygxdqp.github.io/"/>
  <updated>2020-12-03T02:56:55.230Z</updated>
  <id>https://wangmg-ygxdqp.github.io/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>mysql 安装审计插件</title>
    <link href="https://wangmg-ygxdqp.github.io/2020/12/03/mysql-20201203/"/>
    <id>https://wangmg-ygxdqp.github.io/2020/12/03/mysql-20201203/</id>
    <published>2020-12-03T02:40:42.000Z</published>
    <updated>2020-12-03T02:56:55.230Z</updated>
    
    <content type="html"><![CDATA[<p>我这里选择安装的审计插件是 libaudit_plugin.so <a id="more"></a></p><p>插件下载地址：<a href="https://bintray.com/mcafee/mysql-audit-plugin/release#files">libaudit_plugin.so</a></p><p>查看mysql插件目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;plugin_dir&#39;;</span><br></pre></td></tr></table></figure><p>将 libaudit_plugin.so 拷贝到插件目录</p><p>安装插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install plugin audit soname &#39;libaudit_plugin.so&#39;;</span><br></pre></td></tr></table></figure><p>我这里出现了报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1123 (HY000): Can’t initialize function ‘audit’; Plugin initialization function failed.</span><br></pre></td></tr></table></figure><p>从报错很明显是因为加载时初始化出现了问题，可能是数据不一致导致的。</p><p>下载 <a href="https://raw.github.com/mcafee/mysql-audit/master/offset-extract/offset-extract.sh">offset-extract.sh</a> 需要翻墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./offset-extract.sh /usr/sbin/mysqld</span><br><span class="line">&#123;<span class="string">&quot;5.7.19&quot;</span>,<span class="string">&quot;b4633eb887552a3bbb5db3a1eea76e48&quot;</span>, 7800, 7848, 3624, 4776, 456, 360, 0, 32, 64, 160, 536, 7964, 4352, 3648, 3656, 3660, 6048, 2072, 8, 7032, 7072, 7056&#125;</span><br></pre></td></tr></table></figure><p>根据脚本的执行结果修改my.cnf文件，修改好后重启mysql安装插件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">audit_offsets&#x3D;7800, 7848, 3624, 4776, 456, 360, 0, 32, 64, 160, 536, 7964, 4352, 3648, 3656, 3660, 6048, 2072, 8, 7032, 7072, 7056</span><br></pre></td></tr></table></figure><p>检查插件是否已经安装成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES LIKE &#39;%audi%&#39;;</span><br></pre></td></tr></table></figure><p>audit_json_file 这个值的参数为ON表示开启审计功能，audit_json_log_file 就是审计日志所在路径。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;我这里选择安装的审计插件是 libaudit_plugin.so</summary>
    
    
    
    <category term="mysql" scheme="https://wangmg-ygxdqp.github.io/categories/mysql/"/>
    
    
    <category term="mysql" scheme="https://wangmg-ygxdqp.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>StorageClass</title>
    <link href="https://wangmg-ygxdqp.github.io/2020/04/03/StorageClass/"/>
    <id>https://wangmg-ygxdqp.github.io/2020/04/03/StorageClass/</id>
    <published>2020-04-03T07:50:48.000Z</published>
    <updated>2020-12-04T05:13:11.097Z</updated>
    
    <content type="html"><![CDATA[<p>大规模集群中可能会有很多PV，并且不同的应用对存储的要求不同，如果这些PV都需要手动来处理这也是一件很繁琐的事情。StorageClass是一种动态模式的存储卷配置，可以自动创建pv、pvc并进行绑定。<a id="more"></a></p><h1 id="创建存储后端使用nfs的StorageClass"><a href="#创建存储后端使用nfs的StorageClass" class="headerlink" title="创建存储后端使用nfs的StorageClass"></a>创建存储后端使用nfs的StorageClass</h1><p>创建 Provisioner</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.229</span><span class="number">.134</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs_data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.229</span><span class="number">.134</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs_data</span></span><br></pre></td></tr></table></figure><p>将环境变量 NFS_SERVER 和 NFS_PATH 根据nfs服务器的地址与目录替换</p><p>创建serviceAccount</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><p>nfs-client-provisioner 这个sa必须要具备persistentvolumes、persistentvolumeclaims 的增、删、改、查等权限。</p><p>创建StorageClass</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">course-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod,sc</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-cd64fbfc8-p9bg9   1/1     Running   8          17d</span><br><span class="line"></span><br><span class="line">NAME                                             PROVISIONER      AGE</span><br><span class="line">storageclass.storage.k8s.io/course-nfs-storage   fuseim.pri/ifs   17d</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>新建一个 StatefulSet 进行测试</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-web</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><p>通过 volume.beta.kubernetes.io/storage-class: course-nfs-storage 来绑定storageclass</p><p>查看是否自动创建pv、pvc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-web-0                                1/1     Running   0          6m15s</span><br><span class="line">nfs-web-1                                1/1     Running   0          5m46s</span><br><span class="line">nfs-web-2                                1/1     Running   0          5m24s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pvc</span><br><span class="line">www-nfs-web-0   Bound    pvc-a22b63e5-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            course-nfs-storage   5m27s</span><br><span class="line">www-nfs-web-1   Bound    pvc-b39c591c-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            course-nfs-storage   4m57s</span><br><span class="line">www-nfs-web-2   Bound    pvc-c114a430-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            course-nfs-storage   4m35s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br><span class="line">pvc-a22b63e5-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            Delete           Bound    default/www-nfs-web-0       course-nfs-storage            7m39s</span><br><span class="line">pvc-b39c591c-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            Delete           Bound    default/www-nfs-web-1       course-nfs-storage            7m8s</span><br><span class="line">pvc-c114a430-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            Delete           Bound    default/www-nfs-web-2       course-nfs-storage            7m1s</span><br></pre></td></tr></table></figure><p>自动创建的 PV 以${namespace}-${pvcName}-${pvName}这样的命名格式创建在 NFS 服务器上的共享数据目录中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">default-www-nfs-web-0-pvc-a22b63e5-35eb-11eb-90f4-000c2975fe6e</span><br><span class="line">default-www-nfs-web-1-pvc-b39c591c-35eb-11eb-90f4-000c2975fe6e</span><br><span class="line">default-www-nfs-web-2-pvc-c114a430-35eb-11eb-90f4-000c2975fe6e</span><br></pre></td></tr></table></figure><h2 id="如果出现删除pv卡住的情况"><a href="#如果出现删除pv卡住的情况" class="headerlink" title="如果出现删除pv卡住的情况"></a>如果出现删除pv卡住的情况</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch pv <span class="variable">$&#123;pv name&#125;</span> -p <span class="string">&#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://kubernetes.io/docs/concepts/storage/storage-classes">kubernetes StorageClass</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;大规模集群中可能会有很多PV，并且不同的应用对存储的要求不同，如果这些PV都需要手动来处理这也是一件很繁琐的事情。StorageClass是一种动态模式的存储卷配置，可以自动创建pv、pvc并进行绑定。</summary>
    
    
    
    <category term="kubernetes" scheme="https://wangmg-ygxdqp.github.io/categories/kubernetes/"/>
    
    
    <category term="kubernetes.StorageClass" scheme="https://wangmg-ygxdqp.github.io/tags/kubernetes-StorageClass/"/>
    
  </entry>
  
  <entry>
    <title>kafka报错：org.apache.kafka.common.errors.TimeoutException</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/12/02/kafka-20201202/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/12/02/kafka-20201202/</id>
    <published>2019-12-02T09:21:30.000Z</published>
    <updated>2020-12-03T01:32:51.639Z</updated>
    
    <content type="html"><![CDATA[<p>kafka超时这个问题在除去物理网络问题的情况下，最常见的情况是zookeeper.connection.timeout.ms、advertised.host.name 、request.timeout.ms 这三个参数导致的。<a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connection.timeout.ms</span><br></pre></td></tr></table></figure><p>连接 zookeeper 的超时时长，如果这个值设置的比较小可能会造成连接超时。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.timeout.ms</span><br></pre></td></tr></table></figure><p>这个参数的值必须大于zookeeper.connection.timeout.ms，因为当kafka的leader挂掉，broker在zookeeper.connection.timeout.ms配置的时间内不会rebalance，导致导致producer在30秒后出现超时。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">advertised.host.name</span><br></pre></td></tr></table></figure><p>如果发布到zookeeper的advertised.host.name如果没有设置，会默认取java.net.InetAddress.getCanonicalHostName().值，被用于生产端和消费端。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;kafka超时这个问题在除去物理网络问题的情况下，最常见的情况是zookeeper.connection.timeout.ms、advertised.host.name 、request.timeout.ms 这三个参数导致的。</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="kafka" scheme="https://wangmg-ygxdqp.github.io/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>docker客户端通过tcp远程连接dockerd</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/12/02/docker-20201202/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/12/02/docker-20201202/</id>
    <published>2019-12-02T08:39:02.000Z</published>
    <updated>2020-12-02T09:07:01.226Z</updated>
    
    <content type="html"><![CDATA[<p>docker客户端一般默认是本地sock连接，如果需要远程连接的话要改成TCP连接。<a id="more"></a></p><h1 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h1><p>修改systemd启动脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure><p>找到dockerd启动项，找到如下配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br></pre></td></tr></table></figure><p>修改docker配置文件，证书申请步骤在下方。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tlsverify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;tlscert&quot;</span>: <span class="string">&quot;/etc/docker/server-cert.pem&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tlskey&quot;</span>: <span class="string">&quot;/etc/docker/server-key.pem&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tlscacert&quot;</span>: <span class="string">&quot;/etc/docker/ca.pem&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span>:[</span><br><span class="line">    <span class="string">&quot;unix:///var/run/docker.sock&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tcp://0.0.0.0:2376&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="服务端证书与客户端证书申请"><a href="#服务端证书与客户端证书申请" class="headerlink" title="服务端证书与客户端证书申请"></a>服务端证书与客户端证书申请</h1><p>生成 CA 私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -aes256 -out ca-key.pem 4096 </span><br></pre></td></tr></table></figure><p>生成 CA 公钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem</span><br></pre></td></tr></table></figure><h2 id="生成服务端证书"><a href="#生成服务端证书" class="headerlink" title="生成服务端证书"></a>生成服务端证书</h2><p>生成服务器私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out server-key.pem 4096</span><br></pre></td></tr></table></figure><p>用私钥生成证书请求文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -subj <span class="string">&quot;/CN=localhost&quot;</span> -sha256 -new -key server-key.pem -out server.csr</span><br><span class="line">$ <span class="built_in">echo</span> subjectAltName = DNS:localhost,DNS:www.khs1994.com,DNS:tencent,IP:192.168.199.100,IP:192.168.57.110,IP:127.0.0.1 &gt;&gt; extfile.cnf  <span class="comment"># 允许服务端哪些 IP 或 host 能被客户端连接</span></span><br></pre></td></tr></table></figure><p>允许服务端哪些 IP 或 host 能被客户端连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> extendedKeyUsage = serverAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure><p>用 CA 来签署证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -days 365 -sha256 -<span class="keyword">in</span> server.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure><h2 id="生成客户端证书"><a href="#生成客户端证书" class="headerlink" title="生成客户端证书"></a>生成客户端证书</h2><p>生成客户端私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out key.pem 4096</span><br></pre></td></tr></table></figure><p>用私钥生成证书请求文件 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -subj <span class="string">&#x27;/CN=client&#x27;</span> -new -key key.pem -out client.csr </span><br><span class="line">$ <span class="built_in">echo</span> extendedKeyUsage = clientAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure><p>用 CA 来签署证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -days 365 -sha256 -<span class="keyword">in</span> client.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure><p>删除文件，更改文件权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -v client.csr server.csr</span><br><span class="line">$ chmod -v 0400 ca-key.pem key.pem server-key.pem</span><br><span class="line">$ chmod -v 0444 ca.pem server-cert.pem cert.pem</span><br></pre></td></tr></table></figure><h1 id="在客户端测试"><a href="#在客户端测试" class="headerlink" title="在客户端测试"></a>在客户端测试</h1><p>客户端需要ca.pem、cert.pem、key.pem</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker --tlsverify --tlscacert=./ca.pem --tlscert=./cert.pem --tlskey=./key.pem -H=39.106.82.157:2376 info</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;docker客户端一般默认是本地sock连接，如果需要远程连接的话要改成TCP连接。</summary>
    
    
    
    <category term="docker" scheme="https://wangmg-ygxdqp.github.io/categories/docker/"/>
    
    
    <category term="docker" scheme="https://wangmg-ygxdqp.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>kubectl权限控制</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/07/03/kubectl-20201203/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/07/03/kubectl-20201203/</id>
    <published>2019-07-03T08:39:02.000Z</published>
    <updated>2020-12-03T02:29:07.977Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>RBAC使用rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC。<a id="more"></a></p><p>RBAC详解：<a href="https://www.qikqiak.com/post/use-rbac-in-k8s/">kubernetes RBAC</a></p><p>Role：定义权限的集合，作用域为namespace<br>ClusterRole：定义权限的集合，作用域为集群<br>RoleBinding：将Role与sa关联<br>ClusterRoleBinding：将ClusterRole与sa关联</p><h2 id="创建一个只读用户"><a href="#创建一个只读用户" class="headerlink" title="创建一个只读用户"></a>创建一个只读用户</h2><p>创建ClusterRole</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mytest-view</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">serviceaccounts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bindings</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">limitranges</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/log</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/exec</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/exec</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets/scale</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cronjobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f clusterrole-mytest-view.yaml</span><br></pre></td></tr></table></figure><p>创建 ServiceAccount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns mytest</span><br><span class="line">$ kubectl create sa -n mytest user-guest</span><br></pre></td></tr></table></figure><p>创建 ClusterRoleBinding</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns mytest</span><br><span class="line">$ kubectl create sa -n mytest user-guest</span><br></pre></td></tr></table></figure><p>创建 ClusterRoleBinding</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mytest:user-guest</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mytest-view</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-guest</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mytest</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f clusterrolebinding-view.yml</span><br></pre></td></tr></table></figure><h2 id="生成kubeconfig文件"><a href="#生成kubeconfig文件" class="headerlink" title="生成kubeconfig文件"></a>生成kubeconfig文件</h2><p>查看token</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ TOKEN=$(kubectl get sa -n mytest user-guest -o go-template=<span class="string">&#x27;&#123;&#123;range .secrets&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$TOKEN</span></span><br></pre></td></tr></table></figure><p>查看cert</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ CA_CERT=$(kubectl get secret -n mytest <span class="variable">$&#123;TOKEN&#125;</span> -o yaml | awk <span class="string">&#x27;/ca.crt:/&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$CA_CERT</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ API_SERVER=<span class="string">&quot;https://10.100.100.127:6443&quot;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$API_SERVER</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SECRET=$(kubectl -n mytest get secret <span class="variable">$&#123;TOKEN&#125;</span> -o go-template=<span class="string">&#x27;&#123;&#123;.data.token&#125;&#125;&#x27;</span>)</span><br><span class="line">kubectl config set-credentials mytest-guest --token=<span class="built_in">echo</span> <span class="variable">$&#123;SECRET&#125;</span> | base64 -d --kubeconfig=guest.config</span><br><span class="line">kubectl config set-context default --cluster=cluster --user=mytest-guest --kubeconfig=guest.config</span><br><span class="line">kubectl config use-context default --kubeconfig=guest.config</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">server:</span>  <span class="comment">#apiserver的地址</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span>  <span class="comment">#cert</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">cluster</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">mytest-guest</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mytest-guest</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span>  <span class="comment">#token</span></span><br></pre></td></tr></table></figure><p>创建好kubeconfig文件后可以通过这个user-guest这个sa测试，正常的话在删除资源的时候会报错没有delete权限。</p><p>参考文档：<a href="https://www.jianshu.com/p/a1a0d64f1245">kubernetes如何对kubectl做权限管理</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;RBAC&quot;&gt;&lt;a href=&quot;#RBAC&quot; class=&quot;headerlink&quot; title=&quot;RBAC&quot;&gt;&lt;/a&gt;RBAC&lt;/h1&gt;&lt;p&gt;RBAC使用rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC。</summary>
    
    
    
    <category term="kubernetes" scheme="https://wangmg-ygxdqp.github.io/categories/kubernetes/"/>
    
    
    <category term="kubernetes.RBAC" scheme="https://wangmg-ygxdqp.github.io/tags/kubernetes-RBAC/"/>
    
  </entry>
  
  <entry>
    <title>elasticdump导入导出es索引数据</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/06/26/log-20201128/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/06/26/log-20201128/</id>
    <published>2019-06-26T07:51:43.000Z</published>
    <updated>2020-12-02T08:06:26.040Z</updated>
    
    <content type="html"><![CDATA[<p>elasticdump提供了多种导入导出数据的方式，执行的命令也很简单，只需指定数据来源 input 、数据输出 output 、数据类型 type 即可。<a id="more"></a></p><h1 id="通过npm安装elasticdump"><a href="#通过npm安装elasticdump" class="headerlink" title="通过npm安装elasticdump"></a>通过npm安装elasticdump</h1><p>安装nodejs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://nodejs.org/dist/v10.13.0/node-v10.13.0-linux-x64.tar.gz</span><br><span class="line">$ tar xvf node-v10.13.0-linux-x64.tar.gz</span><br><span class="line">$ ln -s ~/node-v10.13.0-linux-x64/bin/node /usr/bin/node</span><br><span class="line">$ ln -s ~/node-v10.13.0-linux-x64/bin/node /usr/bin/node</span><br><span class="line">$ node -v &amp;&amp; npm -v</span><br></pre></td></tr></table></figure><p>安装elasticdump</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br><span class="line">$ npm install elasticdump</span><br><span class="line">$ ln -s ~/node_modules/elasticdump/bin/elasticdump /usr/bin/elasticdump</span><br></pre></td></tr></table></figure><h1 id="导出索引数据"><a href="#导出索引数据" class="headerlink" title="导出索引数据"></a>导出索引数据</h1><p>导出到文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticdump --httpAuthFile=/data/backup/auth.ini --input=http://0.0.0.0:9200/log-2020.04.13 --output=/data/backup/log.json --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><p>–httpAuthFile  #如果es启用了http验证，那么就需要将用户名、密码以ini格式写入文件中。</p><p>导出到压缩包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticdump --httpAuthFile=/data/backup/auth.ini --input=http://0.0.0.0:9200/log-2019.06.13 --output=$ | gzip &gt; /data/backup/log.gz</span><br></pre></td></tr></table></figure><h1 id="导入索引数据"><a href="#导入索引数据" class="headerlink" title="导入索引数据"></a>导入索引数据</h1><p>通过文件导入到es</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticdump --httpAuthFile=/data/backup/auth.ini --output=http:///0.0.0.0:9200/log-2020.06.13 --input=/data/backup/log.json --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><p>其他详细用法：<a href="https://www.npmjs.com/package/elasticdump">elasticdump-npm</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;elasticdump提供了多种导入导出数据的方式，执行的命令也很简单，只需指定数据来源 input 、数据输出 output 、数据类型 type 即可。</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="elasticdump" scheme="https://wangmg-ygxdqp.github.io/tags/elasticdump/"/>
    
  </entry>
  
  <entry>
    <title>elasticsearch 6.8 启用xpack</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/06/25/log-20201127/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/06/25/log-20201127/</id>
    <published>2019-06-25T02:57:40.000Z</published>
    <updated>2020-12-02T03:13:17.325Z</updated>
    
    <content type="html"><![CDATA[<p>x-pack是一个Elastic Stack扩展，提供了安全、报警、监控等功能，默认情况下6.3版本以上的es在安装的时候已自动安装x-pack<a id="more"></a></p><p>安装x-pack，到es的安装目录下的bin下运行。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">elasticsearch-plugin</span> <span class="string">install</span> <span class="string">x-pack</span></span><br></pre></td></tr></table></figure><p>开启x-pack</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>开启x-pack需要开启ssl，否则启动会报错。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure><p>配置ssl证书，到es的安装目录下的bin下依次执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ elasticsearch-certutil ca</span><br><span class="line">$ elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br></pre></td></tr></table></figure><p>elasticsearch-certutil ca 会生成elastic-stack-ca.p12 这个文件，elasticsearch-certutil cert –ca elastic-stack-ca.p12 会生成 elastic-certificates.p12 ，elastic-certificates.p12 就是我们需要的证书。</p><p>添加如下配置（根据你自己的环境指定证书路径）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br></pre></td></tr></table></figure><p>如果使用head插件，需要添加如下配置。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">http.cors.allow-headers:</span> <span class="string">Authorization,X-Requested-With,Content-Length,Content-Type</span></span><br></pre></td></tr></table></figure><p>由于开后x-pack后需要认证，所以head的访问格式也有变化。</p><pre><code>http://head.host:9100/?auth_user=user&amp;auth_password=passwd</code></pre><p>auth_user=用户名，auth_password=密码。</p><p>开启x-pack后es的内置用户会存储在.security索引中，我们需要生成这个索引;到es的安装目录下的bin下运行。（如果误删了.security索引，需要停止es服务安照如下步骤操作）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ elasticsearch-keystore create</span><br><span class="line">$ elasticsearch-setup-passwords interactive</span><br></pre></td></tr></table></figure><p>elastic用户拥有最高权限，可以使用这个用户在kibana上创建用户。</p><p>es开启x-pack后kibana需要认证，在kibana.yaml中添加如下配置。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;your_password&quot;</span></span><br></pre></td></tr></table></figure><p>logstash 同样需要认证，以下为output中的配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [&quot;host1:9200&quot;]</span><br><span class="line">      index &#x3D;&gt; [&quot;name-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">      user &#x3D;&gt; &quot;logstash&quot;</span><br><span class="line">      password &#x3D;&gt; &quot;your_password&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>es完整的配置如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">ELK</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">elk-1</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/dir/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/dir/log/elasticsearch</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;host1&quot;</span>, <span class="string">&quot;host2&quot;</span>]</span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">http.cors.allow-headers:</span> <span class="string">Authorization,X-Requested-With,Content-Length,Content-Type</span></span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://tianmingxing.com/2019/06/20/%E5%9C%A8ElasticSearch6.8%E5%8F%8A%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E5%BC%80%E5%90%AF%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD">es集群加密认证</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;x-pack是一个Elastic Stack扩展，提供了安全、报警、监控等功能，默认情况下6.3版本以上的es在安装的时候已自动安装x-pack</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="kibana" scheme="https://wangmg-ygxdqp.github.io/tags/kibana/"/>
    
    <category term="elasticsearch" scheme="https://wangmg-ygxdqp.github.io/tags/elasticsearch/"/>
    
  </entry>
  
</feed>
