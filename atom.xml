<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wmg的个人主页</title>
  
  
  <link href="https://wangmg-ygxdqp.github.io/atom.xml" rel="self"/>
  
  <link href="https://wangmg-ygxdqp.github.io/"/>
  <updated>2020-12-30T06:06:28.000Z</updated>
  <id>https://wangmg-ygxdqp.github.io/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>kubernetes搭建EFK收集kube集群日志</title>
    <link href="https://wangmg-ygxdqp.github.io/2020/12/30/EFK/"/>
    <id>https://wangmg-ygxdqp.github.io/2020/12/30/EFK/</id>
    <published>2020-12-30T05:18:17.000Z</published>
    <updated>2020-12-30T06:06:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>Fluentd是一个开源的通用日志采集和分发系统，可以从多个数据源采集日志，并将日志过滤和加工后分发到多种存储和处理系统；Fluent-bit是一个用c写成的插件式、轻量级、多平台开源日志收集工具。它允许从不同的源收集数据并发送到多个目的地。完全兼容docker和kubernetes生态环境。<a id="more"></a></p><p>注：yaml文件需要根据实际环境修改</p><h2 id="搭建kafka-与-zookeeper"><a href="#搭建kafka-与-zookeeper" class="headerlink" title="搭建kafka 与 zookeeper"></a>搭建kafka 与 zookeeper</h2><p>zookeeper部署yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-hs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">leader-election</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-cs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2181</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk-pdb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">zk-hs</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">zk</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;app&quot;</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">zk</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-zookeeper</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;tonybian/kubernetes-zookeeper&quot;</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;0.5&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2181</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2888</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3888</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">leader-election</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=3 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=3 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO&quot;</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;zookeeper-ready 2181&quot;</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;zookeeper-ready 2181&quot;</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/zookeeper</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">datadir</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure><p>kafka部署yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-hs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka-pdb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">kafka-hs</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8skafka</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mirrorgooglecontainers/kubernetes-kafka:1.0-10.2.1</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;0.1&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9092</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;exec kafka-server-start.sh /opt/kafka/config/server.properties --override broker.id=$&#123;HOSTNAME##*-&#125; \</span></span><br><span class="line"><span class="string">          --override listeners=PLAINTEXT://:9092 \</span></span><br><span class="line"><span class="string">          --override zookeeper.connect=10.254.213.162:2181 \</span></span><br><span class="line"><span class="string">          --override log.dir=/var/lib/kafka \</span></span><br><span class="line"><span class="string">          --override auto.create.topics.enable=true \</span></span><br><span class="line"><span class="string">          --override auto.leader.rebalance.enable=true \</span></span><br><span class="line"><span class="string">          --override background.threads=10 \</span></span><br><span class="line"><span class="string">          --override compression.type=producer \</span></span><br><span class="line"><span class="string">          --override delete.topic.enable=false \</span></span><br><span class="line"><span class="string">          --override leader.imbalance.check.interval.seconds=300 \</span></span><br><span class="line"><span class="string">          --override leader.imbalance.per.broker.percentage=10 \</span></span><br><span class="line"><span class="string">          --override log.flush.interval.messages=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override log.flush.offset.checkpoint.interval.ms=60000 \</span></span><br><span class="line"><span class="string">          --override log.flush.scheduler.interval.ms=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override log.retention.bytes=-1 \</span></span><br><span class="line"><span class="string">          --override log.retention.hours=168 \</span></span><br><span class="line"><span class="string">          --override log.roll.hours=168 \</span></span><br><span class="line"><span class="string">          --override log.roll.jitter.hours=0 \</span></span><br><span class="line"><span class="string">          --override log.segment.bytes=1073741824 \</span></span><br><span class="line"><span class="string">          --override log.segment.delete.delay.ms=60000 \</span></span><br><span class="line"><span class="string">          --override message.max.bytes=1000012 \</span></span><br><span class="line"><span class="string">          --override min.insync.replicas=1 \</span></span><br><span class="line"><span class="string">          --override num.io.threads=8 \</span></span><br><span class="line"><span class="string">          --override num.network.threads=3 \</span></span><br><span class="line"><span class="string">          --override num.recovery.threads.per.data.dir=1 \</span></span><br><span class="line"><span class="string">          --override num.replica.fetchers=1 \</span></span><br><span class="line"><span class="string">          --override offset.metadata.max.bytes=4096 \</span></span><br><span class="line"><span class="string">          --override offsets.commit.required.acks=-1 \</span></span><br><span class="line"><span class="string">          --override offsets.commit.timeout.ms=5000 \</span></span><br><span class="line"><span class="string">          --override offsets.load.buffer.size=5242880 \</span></span><br><span class="line"><span class="string">          --override offsets.retention.check.interval.ms=600000 \</span></span><br><span class="line"><span class="string">          --override offsets.retention.minutes=1440 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.compression.codec=0 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.num.partitions=50 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.replication.factor=3 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.segment.bytes=104857600 \</span></span><br><span class="line"><span class="string">          --override queued.max.requests=500 \</span></span><br><span class="line"><span class="string">          --override quota.consumer.default=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override quota.producer.default=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.min.bytes=1 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.wait.max.ms=500 \</span></span><br><span class="line"><span class="string">          --override replica.high.watermark.checkpoint.interval.ms=5000 \</span></span><br><span class="line"><span class="string">          --override replica.lag.time.max.ms=10000 \</span></span><br><span class="line"><span class="string">          --override replica.socket.receive.buffer.bytes=65536 \</span></span><br><span class="line"><span class="string">          --override replica.socket.timeout.ms=30000 \</span></span><br><span class="line"><span class="string">          --override request.timeout.ms=30000 \</span></span><br><span class="line"><span class="string">          --override socket.receive.buffer.bytes=102400 \</span></span><br><span class="line"><span class="string">          --override socket.request.max.bytes=104857600 \</span></span><br><span class="line"><span class="string">          --override socket.send.buffer.bytes=102400 \</span></span><br><span class="line"><span class="string">          --override unclean.leader.election.enable=true \</span></span><br><span class="line"><span class="string">          --override zookeeper.session.timeout.ms=6000 \</span></span><br><span class="line"><span class="string">          --override zookeeper.set.acl=false \</span></span><br><span class="line"><span class="string">          --override broker.id.generation.enable=true \</span></span><br><span class="line"><span class="string">          --override connections.max.idle.ms=600000 \</span></span><br><span class="line"><span class="string">          --override controlled.shutdown.enable=true \</span></span><br><span class="line"><span class="string">          --override controlled.shutdown.max.retries=3 \</span></span><br><span class="line"><span class="string">          --override controlled.shutdown.retry.backoff.ms=5000 \</span></span><br><span class="line"><span class="string">          --override controller.socket.timeout.ms=30000 \</span></span><br><span class="line"><span class="string">          --override default.replication.factor=1 \</span></span><br><span class="line"><span class="string">          --override fetch.purgatory.purge.interval.requests=1000 \</span></span><br><span class="line"><span class="string">          --override group.max.session.timeout.ms=300000 \</span></span><br><span class="line"><span class="string">          --override group.min.session.timeout.ms=6000 \</span></span><br><span class="line"><span class="string">          --override inter.broker.protocol.version=0.10.2-IV0 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.backoff.ms=15000 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.dedupe.buffer.size=134217728 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.delete.retention.ms=86400000 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.enable=true \</span></span><br><span class="line"><span class="string">          --override log.cleaner.io.buffer.load.factor=0.9 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.io.buffer.size=524288 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.io.max.bytes.per.second=1.7976931348623157E308 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.min.cleanable.ratio=0.5 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.min.compaction.lag.ms=0 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.threads=1 \</span></span><br><span class="line"><span class="string">          --override log.cleanup.policy=delete \</span></span><br><span class="line"><span class="string">          --override log.index.interval.bytes=4096 \</span></span><br><span class="line"><span class="string">          --override log.index.size.max.bytes=10485760 \</span></span><br><span class="line"><span class="string">          --override log.message.timestamp.difference.max.ms=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override log.message.timestamp.type=CreateTime \</span></span><br><span class="line"><span class="string">          --override log.preallocate=false \</span></span><br><span class="line"><span class="string">          --override log.retention.check.interval.ms=300000 \</span></span><br><span class="line"><span class="string">          --override max.connections.per.ip=2147483647 \</span></span><br><span class="line"><span class="string">          --override num.partitions=3 \</span></span><br><span class="line"><span class="string">          --override producer.purgatory.purge.interval.requests=1000 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.backoff.ms=1000 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.max.bytes=1048576 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.response.max.bytes=10485760 \</span></span><br><span class="line"><span class="string">          --override reserved.broker.max.id=1000 &quot;</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_HEAP_OPTS</span></span><br><span class="line">          <span class="attr">value :</span> <span class="string">&quot;-Xmx256M -Xms256M&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;-Dlogging.level=INFO&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">datadir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/kafka</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">           <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server=localhost:9092&quot;</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">datadir</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure><h2 id="部署elasticsearch-与-kibana"><a href="#部署elasticsearch-与-kibana" class="headerlink" title="部署elasticsearch 与 kibana"></a>部署elasticsearch 与 kibana</h2><p>elasticsearch部署yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-data-db</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch-oss:6.4.3</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9200</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rest</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9300</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">inter-node</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster.name</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">k8s-logs</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node.name</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">discovery.zen.ping.unicast.hosts</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">discovery.zen.minimum_master_nodes</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-Xms512m -Xmx512m&quot;</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">increase-vm-max-map</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sysctl&quot;</span>, <span class="string">&quot;-w&quot;</span>, <span class="string">&quot;vm.max_map_count=262144&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">increase-fd-ulimit</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ulimit -n 65536&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">rest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9300</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">inter-node</span></span><br></pre></td></tr></table></figure><p>kibana部署yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5601</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kibana</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">kibana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.elastic.co/kibana/kibana-oss:6.4.3</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_URL</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">http://elasticsearch:9200</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5601</span></span><br></pre></td></tr></table></figure><h2 id="部署fluentd-与-fluent-bit-收集集群日志"><a href="#部署fluentd-与-fluent-bit-收集集群日志" class="headerlink" title="部署fluentd 与 fluent-bit 收集集群日志"></a>部署fluentd 与 fluent-bit 收集集群日志</h2><p>fluent-bit部署yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit-read</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit-read</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit-read</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluent-bit</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent-bit.conf:</span> <span class="string">|</span></span><br><span class="line">    [<span class="string">SERVICE</span>]</span><br><span class="line">        <span class="string">Flush</span>         <span class="number">1</span></span><br><span class="line">        <span class="string">Log_Level</span>     <span class="string">info</span></span><br><span class="line">        <span class="string">Daemon</span>        <span class="string">off</span></span><br><span class="line">        <span class="string">Parsers_File</span>  <span class="string">parsers.conf</span></span><br><span class="line">        <span class="string">HTTP_Server</span>   <span class="string">On</span></span><br><span class="line">        <span class="string">HTTP_Listen</span>   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">        <span class="string">HTTP_Port</span>     <span class="number">2020</span></span><br><span class="line"></span><br><span class="line">    <span class="string">@INCLUDE</span> <span class="string">input-kubernetes.conf</span></span><br><span class="line">    <span class="string">@INCLUDE</span> <span class="string">filter-kubernetes.conf</span></span><br><span class="line">    <span class="string">@INCLUDE</span> <span class="string">output-elasticsearch.conf</span></span><br><span class="line">    [<span class="string">INPUT</span>]</span><br><span class="line">        <span class="string">Name</span>              <span class="string">tail</span></span><br><span class="line">        <span class="string">Tag</span>               <span class="string">kube.*</span></span><br><span class="line">        <span class="string">Path</span>              <span class="string">/var/log/containers/*.log</span></span><br><span class="line">        <span class="string">Parser</span>            <span class="string">docker</span></span><br><span class="line">        <span class="string">DB</span>                <span class="string">/var/log/flb_kube.db</span></span><br><span class="line">        <span class="string">Refresh_Interval</span>  <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">filter-kubernetes.conf:</span> <span class="string">|</span></span><br><span class="line">    [<span class="string">FILTER</span>]</span><br><span class="line">        <span class="string">Name</span>                <span class="string">kubernetes</span></span><br><span class="line">        <span class="string">Match</span>               <span class="string">kube.*</span></span><br><span class="line">        <span class="string">Kube_URL</span>            <span class="string">https://kubernetes.default.svc:443</span></span><br><span class="line">        <span class="string">Kube_CA_File</span>        <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">        <span class="string">Kube_Token_File</span>     <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="string">Kube_Tag_Prefix</span>     <span class="string">kube.var.log.containers.</span></span><br><span class="line">        <span class="string">Merge_Log</span>           <span class="string">On</span></span><br><span class="line">        <span class="string">K8S-Logging.Exclude</span> <span class="string">Off</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">output-elasticsearch.conf:</span> <span class="string">|</span></span><br><span class="line">    [<span class="string">OUTPUT</span>]</span><br><span class="line">        <span class="string">Name</span>            <span class="string">kafka</span></span><br><span class="line">        <span class="string">Match</span>           <span class="string">*</span></span><br><span class="line">        <span class="string">Brokers</span>         <span class="string">kafka-hs:9092</span></span><br><span class="line">        <span class="string">Topics</span>          <span class="string">kube_node</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">parsers.conf:</span> <span class="string">|</span></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span>   <span class="string">apache</span></span><br><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span><br><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span>   <span class="string">apache2</span></span><br><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span><br><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Regex</span>  <span class="string">^\[[^</span> <span class="string">]*</span> <span class="string">(?&lt;time&gt;[^\]]*)\]</span> <span class="string">\[(?&lt;level&gt;[^\]]*)\](?:</span> <span class="string">\[pid</span> <span class="string">(?&lt;pid&gt;[^\]]*)\])?(</span> <span class="string">\[client</span> <span class="string">(?&lt;client&gt;[^\]]*)\])?</span> <span class="string">(?&lt;message&gt;.*)$</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span>   <span class="string">nginx</span></span><br><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span><br><span class="line">        <span class="string">Regex</span> <span class="string">^(?&lt;remote&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;user&gt;[^</span> <span class="string">]*)</span> <span class="string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="string">&quot;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\&quot;]*?)(?: +\S*)?)?&quot;</span> <span class="string">(?&lt;code&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;size&gt;[^</span> <span class="string">]*)(</span></span><br><span class="line"><span class="string">?:</span> <span class="string">&quot;(?&lt;referer&gt;[^\&quot;]*)&quot;</span> <span class="string">&quot;(?&lt;agent&gt;[^\&quot;]*)&quot;</span><span class="string">)?$</span></span><br><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span>   <span class="string">json</span></span><br><span class="line">        <span class="string">Format</span> <span class="string">json</span></span><br><span class="line">        <span class="string">Time_Key</span> <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%d/%b/%Y:%H:%M:%S</span> <span class="string">%z</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span>        <span class="string">docker</span></span><br><span class="line">        <span class="string">Format</span>      <span class="string">json</span></span><br><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%Y-%m-%dT%H:%M:%S.%L</span></span><br><span class="line">        <span class="string">Time_Keep</span>   <span class="string">On</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span> <span class="string">cri</span></span><br><span class="line">        <span class="string">Format</span> <span class="string">regex</span></span><br><span class="line">        <span class="string">Regex</span> <span class="string">^(?&lt;time&gt;[^</span> <span class="string">]+)</span> <span class="string">(?&lt;stream&gt;stdout|stderr)</span> <span class="string">(?&lt;logtag&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;message&gt;.*)$</span></span><br><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%Y-%m-%dT%H:%M:%S.%L%z</span></span><br><span class="line"></span><br><span class="line">    [<span class="string">PARSER</span>]</span><br><span class="line">        <span class="string">Name</span>        <span class="string">syslog</span></span><br><span class="line">        <span class="string">Format</span>      <span class="string">regex</span></span><br><span class="line">        <span class="string">Regex</span>       <span class="string">^\&lt;(?&lt;pri&gt;[0-9]+)\&gt;(?&lt;time&gt;[^</span> <span class="string">]*</span> &#123;<span class="number">1</span>,<span class="number">2</span>&#125;[<span class="string">^</span> ]<span class="string">*</span> [<span class="string">^</span> ]<span class="string">*)</span> <span class="string">(?&lt;host&gt;[^</span> <span class="string">]*)</span> <span class="string">(?&lt;ident&gt;[a-zA-Z0-9_\/\.\-]*)(?:\[(?&lt;pid&gt;[0-9]+)\])?(?:[^\:]*\:)?</span> <span class="string">*(?&lt;messag</span></span><br><span class="line"><span class="string">e&gt;.*)$</span></span><br><span class="line">        <span class="string">Time_Key</span>    <span class="string">time</span></span><br><span class="line">        <span class="string">Time_Format</span> <span class="string">%b</span> <span class="string">%d</span> <span class="string">%H:%M:%S</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluent-bit</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluent-bit-logging</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">fluent-bit-logging</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">fluent-bit-logging</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">        <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;2020&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/path:</span> <span class="string">/api/v1/metrics/prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluent-bit</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">fluent/fluent-bit:1.5</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2020</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluent-bit-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/fluent-bit/etc/</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluent-bit-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">fluent-bit-config</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">fluent-bit</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure><p>fluentd部署yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">fluent.conf:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">&lt;source&gt;</span></span><br><span class="line">      <span class="string">@type</span> <span class="string">kafka</span></span><br><span class="line">      <span class="string">brokers</span> <span class="string">kafka-hs:9092</span></span><br><span class="line">      <span class="string">topics</span> <span class="string">kube_node</span></span><br><span class="line">      <span class="string">format</span> <span class="string">json</span></span><br><span class="line">    <span class="string">&lt;/source&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&lt;match</span> <span class="string">*&gt;</span></span><br><span class="line">      <span class="string">@type</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="string">host</span> <span class="string">elasticsearch</span></span><br><span class="line">      <span class="string">port</span> <span class="number">9200</span></span><br><span class="line">      <span class="string">type_name</span> <span class="string">fluentd-k8s</span></span><br><span class="line">      <span class="string">logstash_format</span> <span class="literal">true</span></span><br><span class="line">      <span class="string">logstash_prefix</span> <span class="string">fluentd-k8s</span></span><br><span class="line">      <span class="string">&lt;buffer&gt;</span></span><br><span class="line">        <span class="string">@type</span> <span class="string">file</span></span><br><span class="line">        <span class="string">path</span> <span class="string">/var/log/fluentd-buffers/kubernetes.system.buffer</span></span><br><span class="line">        <span class="string">flush_mode</span> <span class="string">interval</span></span><br><span class="line">        <span class="string">retry_type</span> <span class="string">exponential_backoff</span></span><br><span class="line">        <span class="string">flush_thread_count</span> <span class="number">2</span></span><br><span class="line">        <span class="string">flush_interval</span> <span class="string">5s</span></span><br><span class="line">        <span class="string">retry_forever</span></span><br><span class="line">        <span class="string">retry_max_interval</span> <span class="number">30</span></span><br><span class="line">        <span class="string">chunk_limit_size</span> <span class="string">2M</span></span><br><span class="line">        <span class="string">queue_limit_length</span> <span class="number">8</span></span><br><span class="line">        <span class="string">overflow_action</span> <span class="string">block</span></span><br><span class="line">      <span class="string">&lt;/buffer&gt;</span></span><br><span class="line">    <span class="string">&lt;/match&gt;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-es</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-es</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;namespaces&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;pods&quot;</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;get&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;watch&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;list&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-es</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-es</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2.0.4</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">fluentd-es</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2.0.4</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">fluentd-es</span></span><br><span class="line">        <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2.0.4</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">fluentd-es</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-es</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ygxdqp/fluentd-es-kafka:v1.1.1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLUENTD_ARGS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">--no-supervisor</span> <span class="string">-q</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/fluent/</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">fluentd-config</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Fluentd是一个开源的通用日志采集和分发系统，可以从多个数据源采集日志，并将日志过滤和加工后分发到多种存储和处理系统；Fluent-bit是一个用c写成的插件式、轻量级、多平台开源日志收集工具。它允许从不同的源收集数据并发送到多个目的地。完全兼容docker和kubernetes生态环境。</summary>
    
    
    
    <category term="EFK" scheme="https://wangmg-ygxdqp.github.io/categories/EFK/"/>
    
    
    <category term="kafka" scheme="https://wangmg-ygxdqp.github.io/tags/kafka/"/>
    
    <category term="elasticsearch" scheme="https://wangmg-ygxdqp.github.io/tags/elasticsearch/"/>
    
    <category term="zookeeper" scheme="https://wangmg-ygxdqp.github.io/tags/zookeeper/"/>
    
    <category term="fluentd" scheme="https://wangmg-ygxdqp.github.io/tags/fluentd/"/>
    
    <category term="fluent-bit" scheme="https://wangmg-ygxdqp.github.io/tags/fluent-bit/"/>
    
  </entry>
  
  <entry>
    <title>mysql 安装审计插件</title>
    <link href="https://wangmg-ygxdqp.github.io/2020/06/03/mysql-20201203/"/>
    <id>https://wangmg-ygxdqp.github.io/2020/06/03/mysql-20201203/</id>
    <published>2020-06-03T02:40:42.000Z</published>
    <updated>2020-12-04T05:45:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>我这里选择安装的审计插件是 libaudit_plugin.so <a id="more"></a></p><p>插件下载地址：<a href="https://bintray.com/mcafee/mysql-audit-plugin/release#files">libaudit_plugin.so</a></p><p>查看mysql插件目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;plugin_dir&#39;;</span><br></pre></td></tr></table></figure><p>将 libaudit_plugin.so 拷贝到插件目录</p><p>安装插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install plugin audit soname &#39;libaudit_plugin.so&#39;;</span><br></pre></td></tr></table></figure><p>我这里出现了报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1123 (HY000): Can’t initialize function ‘audit’; Plugin initialization function failed.</span><br></pre></td></tr></table></figure><p>从报错很明显是因为加载时初始化出现了问题，可能是数据不一致导致的。</p><p>下载 <a href="https://raw.github.com/mcafee/mysql-audit/master/offset-extract/offset-extract.sh">offset-extract.sh</a> 需要翻墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./offset-extract.sh /usr/sbin/mysqld</span><br><span class="line">&#123;<span class="string">&quot;5.7.19&quot;</span>,<span class="string">&quot;b4633eb887552a3bbb5db3a1eea76e48&quot;</span>, 7800, 7848, 3624, 4776, 456, 360, 0, 32, 64, 160, 536, 7964, 4352, 3648, 3656, 3660, 6048, 2072, 8, 7032, 7072, 7056&#125;</span><br></pre></td></tr></table></figure><p>根据脚本的执行结果修改my.cnf文件，修改好后重启mysql安装插件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">audit_offsets&#x3D;7800, 7848, 3624, 4776, 456, 360, 0, 32, 64, 160, 536, 7964, 4352, 3648, 3656, 3660, 6048, 2072, 8, 7032, 7072, 7056</span><br></pre></td></tr></table></figure><p>检查插件是否已经安装成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES LIKE &#39;%audi%&#39;;</span><br></pre></td></tr></table></figure><p>audit_json_file 这个值的参数为ON表示开启审计功能，audit_json_log_file 就是审计日志所在路径。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;我这里选择安装的审计插件是 libaudit_plugin.so</summary>
    
    
    
    <category term="mysql" scheme="https://wangmg-ygxdqp.github.io/categories/mysql/"/>
    
    
    <category term="mysql" scheme="https://wangmg-ygxdqp.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>StorageClass</title>
    <link href="https://wangmg-ygxdqp.github.io/2020/04/03/StorageClass/"/>
    <id>https://wangmg-ygxdqp.github.io/2020/04/03/StorageClass/</id>
    <published>2020-04-03T07:50:48.000Z</published>
    <updated>2020-12-04T05:13:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>大规模集群中可能会有很多PV，并且不同的应用对存储的要求不同，如果这些PV都需要手动来处理这也是一件很繁琐的事情。StorageClass是一种动态模式的存储卷配置，可以自动创建pv、pvc并进行绑定。<a id="more"></a></p><h1 id="创建存储后端使用nfs的StorageClass"><a href="#创建存储后端使用nfs的StorageClass" class="headerlink" title="创建存储后端使用nfs的StorageClass"></a>创建存储后端使用nfs的StorageClass</h1><p>创建 Provisioner</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.229</span><span class="number">.134</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs_data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.229</span><span class="number">.134</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs_data</span></span><br></pre></td></tr></table></figure><p>将环境变量 NFS_SERVER 和 NFS_PATH 根据nfs服务器的地址与目录替换</p><p>创建serviceAccount</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><p>nfs-client-provisioner 这个sa必须要具备persistentvolumes、persistentvolumeclaims 的增、删、改、查等权限。</p><p>创建StorageClass</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">course-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod,sc</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-cd64fbfc8-p9bg9   1/1     Running   8          17d</span><br><span class="line"></span><br><span class="line">NAME                                             PROVISIONER      AGE</span><br><span class="line">storageclass.storage.k8s.io/course-nfs-storage   fuseim.pri/ifs   17d</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>新建一个 StatefulSet 进行测试</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-web</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">course-nfs-storage</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><p>通过 volume.beta.kubernetes.io/storage-class: course-nfs-storage 来绑定storageclass</p><p>查看是否自动创建pv、pvc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-web-0                                1/1     Running   0          6m15s</span><br><span class="line">nfs-web-1                                1/1     Running   0          5m46s</span><br><span class="line">nfs-web-2                                1/1     Running   0          5m24s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pvc</span><br><span class="line">www-nfs-web-0   Bound    pvc-a22b63e5-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            course-nfs-storage   5m27s</span><br><span class="line">www-nfs-web-1   Bound    pvc-b39c591c-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            course-nfs-storage   4m57s</span><br><span class="line">www-nfs-web-2   Bound    pvc-c114a430-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            course-nfs-storage   4m35s</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br><span class="line">pvc-a22b63e5-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            Delete           Bound    default/www-nfs-web-0       course-nfs-storage            7m39s</span><br><span class="line">pvc-b39c591c-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            Delete           Bound    default/www-nfs-web-1       course-nfs-storage            7m8s</span><br><span class="line">pvc-c114a430-35eb-11eb-90f4-000c2975fe6e   1Gi        RWO            Delete           Bound    default/www-nfs-web-2       course-nfs-storage            7m1s</span><br></pre></td></tr></table></figure><p>自动创建的 PV 以${namespace}-${pvcName}-${pvName}这样的命名格式创建在 NFS 服务器上的共享数据目录中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">default-www-nfs-web-0-pvc-a22b63e5-35eb-11eb-90f4-000c2975fe6e</span><br><span class="line">default-www-nfs-web-1-pvc-b39c591c-35eb-11eb-90f4-000c2975fe6e</span><br><span class="line">default-www-nfs-web-2-pvc-c114a430-35eb-11eb-90f4-000c2975fe6e</span><br></pre></td></tr></table></figure><h2 id="如果出现删除pv卡住的情况"><a href="#如果出现删除pv卡住的情况" class="headerlink" title="如果出现删除pv卡住的情况"></a>如果出现删除pv卡住的情况</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch pv <span class="variable">$&#123;pv name&#125;</span> -p <span class="string">&#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://kubernetes.io/docs/concepts/storage/storage-classes">kubernetes StorageClass</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;大规模集群中可能会有很多PV，并且不同的应用对存储的要求不同，如果这些PV都需要手动来处理这也是一件很繁琐的事情。StorageClass是一种动态模式的存储卷配置，可以自动创建pv、pvc并进行绑定。</summary>
    
    
    
    <category term="kubernetes" scheme="https://wangmg-ygxdqp.github.io/categories/kubernetes/"/>
    
    
    <category term="kubernetes.StorageClass" scheme="https://wangmg-ygxdqp.github.io/tags/kubernetes-StorageClass/"/>
    
  </entry>
  
  <entry>
    <title>ruby正则表达式</title>
    <link href="https://wangmg-ygxdqp.github.io/2020/01/04/ruby%E6%AD%A3%E5%88%99/"/>
    <id>https://wangmg-ygxdqp.github.io/2020/01/04/ruby%E6%AD%A3%E5%88%99/</id>
    <published>2020-01-04T07:34:01.000Z</published>
    <updated>2021-01-04T08:23:04.000Z</updated>
    
    <content type="html"><![CDATA[<p>ruby正则表达式汇总。logstash的grok插件使用的是ruby的正则，可以根据本文对照。<a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">^            匹配行的开头。</span><br><span class="line">$            匹配行的结尾。</span><br><span class="line">.            匹配除了换行符以外的任意单字符。使用 m 选项时，它也可以匹配换行符。</span><br><span class="line">[...]            匹配在方括号中的任意单字符。</span><br><span class="line">[^...]            匹配不在方括号中的任意单字符。</span><br><span class="line">re*            匹配前面的子表达式零次或多次。</span><br><span class="line">re+            匹配前面的子表达式一次或多次。</span><br><span class="line">re?            匹配前面的子表达式零次或一次。</span><br><span class="line">re&#123; n&#125;            匹配前面的子表达式 n 次。</span><br><span class="line">re&#123; n,&#125;            匹配前面的子表达式 n 次或 n 次以上。</span><br><span class="line">re&#123; n, m&#125;    匹配前面的子表达式至少 n 次至多 m 次。</span><br><span class="line">a| b            匹配 a 或 b。</span><br><span class="line">(re)            对正则表达式进行分组，并记住匹配文本。</span><br><span class="line">(?imx)            暂时打开正则表达式内的 i、 m 或 x 选项。如果在圆括号中，则只影响圆括号内的部分。</span><br><span class="line">(?-imx)            暂时关闭正则表达式内的 i、 m 或 x 选项。如果在圆括号中，则只影响圆括号内的部分。</span><br><span class="line">(?: re)            对正则表达式进行分组，但不记住匹配文本。</span><br><span class="line">(?imx: re)    暂时打开圆括号内的 i、 m 或 x 选项。</span><br><span class="line">(?-imx: re)    暂时关闭圆括号内的 i、 m 或 x 选项。</span><br><span class="line">(?#...)            注释。</span><br><span class="line">(?&#x3D; re)            使用模式指定位置。没有范围。</span><br><span class="line">(?! re)            使用模式的否定指定位置。没有范围。</span><br><span class="line">(?&gt; re)            匹配无回溯的独立模式。</span><br><span class="line">\w            匹配单词字符。</span><br><span class="line">\W            匹配非单词字符。</span><br><span class="line">\s            匹配空白字符。等价于 [\t\n\r\f]。</span><br><span class="line">\S            匹配非空白字符。</span><br><span class="line">\d            匹配数字。等价于 [0-9]。</span><br><span class="line">\D            匹配非数字。</span><br><span class="line">\A            匹配字符串的开头。</span><br><span class="line">\Z            匹配字符串的结尾。如果存在换行符，则只匹配到换行符之前。</span><br><span class="line">\z            匹配字符串的结尾。</span><br><span class="line">\G            匹配最后一个匹配完成的点。</span><br><span class="line">\b            当在括号外时匹配单词边界，当在括号内时匹配退格键（0x08）。</span><br><span class="line">\B            匹配非单词边界。</span><br><span class="line">\n, \t, etc.    匹配换行符、回车符、制表符，等等。</span><br><span class="line">\1...\9            匹配第 n 个分组子表达式。</span><br><span class="line">\10            如果已匹配过，则匹配第 n 个分组子表达式。否则指向字符编码的八进制表示。</span><br><span class="line">&#x2F;ruby&#x2F;            匹配 &quot;ruby&quot;</span><br></pre></td></tr></table></figure><p>匹配特殊字符</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;.&#x2F;    匹配除了换行符以外的其他任意字符</span><br><span class="line">&#x2F;.&#x2F;m    在多行模式下，也能匹配换行符</span><br><span class="line">&#x2F;\d&#x2F;    匹配一个数字，等同于 &#x2F;[0-9]&#x2F;</span><br><span class="line">&#x2F;\D&#x2F;    匹配一个非数字，等同于 &#x2F;[^0-9]&#x2F;</span><br><span class="line">&#x2F;\s&#x2F;    匹配一个空白字符，等同于 &#x2F;[ \t\r\n\f]&#x2F;</span><br><span class="line">&#x2F;\S&#x2F;    匹配一个非空白字符，等同于 &#x2F;[^ \t\r\n\f]&#x2F;</span><br><span class="line">&#x2F;\w&#x2F;    匹配一个单词字符，等同于 &#x2F;[A-Za-z0-9_]&#x2F;</span><br><span class="line">&#x2F;\W&#x2F;    匹配一个非单词字符，等同于 &#x2F;[^A-Za-z0-9_]&#x2F;</span><br></pre></td></tr></table></figure><p>重复匹配</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;ruby?&#x2F;        匹配 &quot;rub&quot; 或 &quot;ruby&quot;。其中，y 是可有可无的。</span><br><span class="line">&#x2F;ruby*&#x2F;        匹配 &quot;rub&quot; 加上 0 个或多个的 y。</span><br><span class="line">&#x2F;ruby+&#x2F;        匹配 &quot;rub&quot; 加上 1 个或多个的 y。</span><br><span class="line">&#x2F;\d&#123;3&#125;&#x2F;        刚好匹配 3 个数字。</span><br><span class="line">&#x2F;\d&#123;3,&#125;&#x2F;匹配 3 个或多个数字。</span><br><span class="line">&#x2F;\d&#123;3,5&#125;&#x2F;匹配 3 个、4 个或 5 个数字。</span><br></pre></td></tr></table></figure><p>分组</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;\D\d+&#x2F;                    无分组： + 重复 \d</span><br><span class="line">&#x2F;(\D\d)+&#x2F;            分组： + 重复 \D\d 对</span><br><span class="line">&#x2F;([Rr]uby(, )?)+&#x2F;    匹配 &quot;Ruby&quot;、&quot;Ruby, ruby, ruby&quot;，等等</span><br><span class="line">&#x2F;([Rr])uby&amp;\1ails&#x2F;    匹配 ruby&amp;rails 或 Ruby&amp;Rails</span><br><span class="line">&#x2F;([&#39;&quot;])(?:(?!\1).)*\1&#x2F;    单引号或双引号字符串。\1 匹配第一个分组所匹配的字符，\2 匹配第二个分组所匹配的字符，依此类推。</span><br></pre></td></tr></table></figure><p>替换</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;ruby|rube&#x2F;    匹配 &quot;ruby&quot; 或 &quot;rube&quot;</span><br><span class="line">&#x2F;rub(y|le)&#x2F;    匹配 &quot;ruby&quot; 或 &quot;ruble&quot;</span><br><span class="line">&#x2F;ruby(!+|\?)&#x2F;    &quot;ruby&quot; 后跟一个或多个 ! 或者跟一个 ?</span><br></pre></td></tr></table></figure><p>位置锚定</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;^Ruby&#x2F;          匹配以 &quot;Ruby&quot; 开头的字符串或行</span><br><span class="line">&#x2F;Ruby$&#x2F;          匹配以 &quot;Ruby&quot; 结尾的字符串或行</span><br><span class="line">&#x2F;\ARuby&#x2F;  匹配以 &quot;Ruby&quot; 开头的字符串</span><br><span class="line">&#x2F;Ruby\Z&#x2F;  匹配以 &quot;Ruby&quot; 结尾的字符串</span><br><span class="line">&#x2F;\bRuby\b&#x2F;  匹配单词边界的 &quot;Ruby&quot;</span><br><span class="line">&#x2F;\brub\B&#x2F;  \B 是非单词边界：匹配 &quot;rube&quot; 和 &quot;ruby&quot; 中的 &quot;rub&quot;，但不匹配单独的 &quot;rub&quot;</span><br><span class="line">&#x2F;Ruby(?&#x3D;!)&#x2F;  如果 &quot;Ruby&quot; 后跟着一个感叹号，则匹配 &quot;Ruby&quot;</span><br><span class="line">&#x2F;Ruby(?!!)&#x2F;  如果 &quot;Ruby&quot; 后没有跟着一个感叹号，则匹配 &quot;Ruby&quot;</span><br></pre></td></tr></table></figure><p>特殊语法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;R(?#comment)&#x2F;     匹配 &quot;R&quot;。所有剩余的字符都是注释。</span><br><span class="line">&#x2F;R(?i)uby&#x2F;     当匹配 &quot;uby&quot; 时不区分大小写。</span><br><span class="line">&#x2F;R(?i:uby)&#x2F;     与上面相同。</span><br><span class="line">&#x2F;rub(?:y|le))&#x2F;     只分组，不进行 \1 反向引用</span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://www.runoob.com/ruby/ruby-regular-expressions.html">ruby正则表达式</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ruby正则表达式汇总。logstash的grok插件使用的是ruby的正则，可以根据本文对照。</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="ruby" scheme="https://wangmg-ygxdqp.github.io/tags/ruby/"/>
    
  </entry>
  
  <entry>
    <title>centos7 更新 kernel</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/12/28/centos7/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/12/28/centos7/</id>
    <published>2019-12-28T09:21:45.000Z</published>
    <updated>2021-01-10T07:51:24.699Z</updated>
    
    <content type="html"><![CDATA[<p>centos7 的内核版本为3.1，Docker overlay2需要使用kernel 4.x版本，如果使用overlay2我们需要升级内核。<a id="more"></a></p><p>添加yum源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line">$ yum install https://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</span><br></pre></td></tr></table></figure><p>查询可安装的内核版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ yum --disablerepo=<span class="string">&quot;*&quot;</span> --enablerepo=<span class="string">&quot;elrepo-kernel&quot;</span> list available</span><br><span class="line">elrepo-release.noarch                                   7.0-5.el7.elrepo                       elrepo-kernel</span><br><span class="line">kernel-lt.x86_64                                        4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-lt-devel.x86_64                                  4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-lt-doc.noarch                                    4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-lt-headers.x86_64                                4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-lt-tools.x86_64                                  4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-lt-tools-libs.x86_64                             4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-lt-tools-libs-devel.x86_64                       4.4.248-1.el7.elrepo                   elrepo-kernel</span><br><span class="line">kernel-ml.x86_64                                        5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">kernel-ml-devel.x86_64                                  5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">kernel-ml-doc.noarch                                    5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">kernel-ml-headers.x86_64                                5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">kernel-ml-tools.x86_64                                  5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">kernel-ml-tools-libs.x86_64                             5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">kernel-ml-tools-libs-devel.x86_64                       5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">perf.x86_64                                             5.10.3-1.el7.elrepo                    elrepo-kernel</span><br><span class="line">python-perf.x86_64                                      5.10.3-1.el7.elrepo                    elrepo-kernel</span><br></pre></td></tr></table></figure><p>安装（lt为长期稳定版本，mt为最新的版本）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum --enablerepo=elrepo-kernel install kernel-lt</span><br></pre></td></tr></table></figure><p>修改默认启动顺序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br></pre></td></tr></table></figure><p>查看默认启动内核</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ grubby --default-kernel</span><br><span class="line">/boot/vmlinuz-4.4.248-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure><p>修改好后确认无误重启，可以在启动界面看到新安装的内核。</p><p>查看当前系统内核</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br><span class="line">4.4.248-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;centos7 的内核版本为3.1，Docker overlay2需要使用kernel 4.x版本，如果使用overlay2我们需要升级内核。</summary>
    
    
    
    <category term="centos" scheme="https://wangmg-ygxdqp.github.io/categories/centos/"/>
    
    
    <category term="kernel" scheme="https://wangmg-ygxdqp.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>kafka报错：org.apache.kafka.common.errors.TimeoutException</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/12/02/kafka-20201202/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/12/02/kafka-20201202/</id>
    <published>2019-12-02T09:21:30.000Z</published>
    <updated>2020-12-03T01:32:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>kafka超时这个问题在除去物理网络问题的情况下，最常见的情况是zookeeper.connection.timeout.ms、advertised.host.name 、request.timeout.ms 这三个参数导致的。<a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connection.timeout.ms</span><br></pre></td></tr></table></figure><p>连接 zookeeper 的超时时长，如果这个值设置的比较小可能会造成连接超时。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.timeout.ms</span><br></pre></td></tr></table></figure><p>这个参数的值必须大于zookeeper.connection.timeout.ms，因为当kafka的leader挂掉，broker在zookeeper.connection.timeout.ms配置的时间内不会rebalance，导致导致producer在30秒后出现超时。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">advertised.host.name</span><br></pre></td></tr></table></figure><p>如果发布到zookeeper的advertised.host.name如果没有设置，会默认取java.net.InetAddress.getCanonicalHostName().值，被用于生产端和消费端。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;kafka超时这个问题在除去物理网络问题的情况下，最常见的情况是zookeeper.connection.timeout.ms、advertised.host.name 、request.timeout.ms 这三个参数导致的。</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="kafka" scheme="https://wangmg-ygxdqp.github.io/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>docker客户端通过tcp远程连接dockerd</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/12/02/docker-20201202/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/12/02/docker-20201202/</id>
    <published>2019-12-02T08:39:02.000Z</published>
    <updated>2020-12-02T09:07:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>docker客户端一般默认是本地sock连接，如果需要远程连接的话要改成TCP连接。<a id="more"></a></p><h1 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h1><p>修改systemd启动脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure><p>找到dockerd启动项，找到如下配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br></pre></td></tr></table></figure><p>修改docker配置文件，证书申请步骤在下方。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tlsverify&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;tlscert&quot;</span>: <span class="string">&quot;/etc/docker/server-cert.pem&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tlskey&quot;</span>: <span class="string">&quot;/etc/docker/server-key.pem&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tlscacert&quot;</span>: <span class="string">&quot;/etc/docker/ca.pem&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span>:[</span><br><span class="line">    <span class="string">&quot;unix:///var/run/docker.sock&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tcp://0.0.0.0:2376&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="服务端证书与客户端证书申请"><a href="#服务端证书与客户端证书申请" class="headerlink" title="服务端证书与客户端证书申请"></a>服务端证书与客户端证书申请</h1><p>生成 CA 私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -aes256 -out ca-key.pem 4096 </span><br></pre></td></tr></table></figure><p>生成 CA 公钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem</span><br></pre></td></tr></table></figure><h2 id="生成服务端证书"><a href="#生成服务端证书" class="headerlink" title="生成服务端证书"></a>生成服务端证书</h2><p>生成服务器私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out server-key.pem 4096</span><br></pre></td></tr></table></figure><p>用私钥生成证书请求文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -subj <span class="string">&quot;/CN=localhost&quot;</span> -sha256 -new -key server-key.pem -out server.csr</span><br><span class="line">$ <span class="built_in">echo</span> subjectAltName = DNS:localhost,DNS:www.khs1994.com,DNS:tencent,IP:192.168.199.100,IP:192.168.57.110,IP:127.0.0.1 &gt;&gt; extfile.cnf  <span class="comment"># 允许服务端哪些 IP 或 host 能被客户端连接</span></span><br></pre></td></tr></table></figure><p>允许服务端哪些 IP 或 host 能被客户端连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> extendedKeyUsage = serverAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure><p>用 CA 来签署证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -days 365 -sha256 -<span class="keyword">in</span> server.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure><h2 id="生成客户端证书"><a href="#生成客户端证书" class="headerlink" title="生成客户端证书"></a>生成客户端证书</h2><p>生成客户端私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out key.pem 4096</span><br></pre></td></tr></table></figure><p>用私钥生成证书请求文件 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -subj <span class="string">&#x27;/CN=client&#x27;</span> -new -key key.pem -out client.csr </span><br><span class="line">$ <span class="built_in">echo</span> extendedKeyUsage = clientAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure><p>用 CA 来签署证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -days 365 -sha256 -<span class="keyword">in</span> client.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure><p>删除文件，更改文件权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -v client.csr server.csr</span><br><span class="line">$ chmod -v 0400 ca-key.pem key.pem server-key.pem</span><br><span class="line">$ chmod -v 0444 ca.pem server-cert.pem cert.pem</span><br></pre></td></tr></table></figure><h1 id="在客户端测试"><a href="#在客户端测试" class="headerlink" title="在客户端测试"></a>在客户端测试</h1><p>客户端需要ca.pem、cert.pem、key.pem</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker --tlsverify --tlscacert=./ca.pem --tlscert=./cert.pem --tlskey=./key.pem -H=39.106.82.157:2376 info</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;docker客户端一般默认是本地sock连接，如果需要远程连接的话要改成TCP连接。</summary>
    
    
    
    <category term="docker" scheme="https://wangmg-ygxdqp.github.io/categories/docker/"/>
    
    
    <category term="docker" scheme="https://wangmg-ygxdqp.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>ingress</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/07/04/ingress/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/07/04/ingress/</id>
    <published>2019-07-04T07:50:48.000Z</published>
    <updated>2020-12-09T05:40:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>Ingress 相当于负载均衡器的路由配置信息；Ingress controller 可以理解为一个监听器，实时的感知后端 service、pod 的变化，当得到这些变化信息后，Ingress controller 再结合 Ingress 的配置，更新反向代理负载均衡器，达到服务发现的作用。<a id="more"></a></p><h1 id="ingress-安装"><a href="#ingress-安装" class="headerlink" title="ingress 安装"></a>ingress 安装</h1><p>可供选择的ingress controller 有很多，比如 <a href="https://traefik.io/">traefik</a>、<a href="https://kubernetes.github.io/ingress-nginx">nginx-controller</a>、<a href="https://konghq.com/blog/kubernetes-ingress-controller-for-kong">Kubernetes Ingress Controller for Kong</a>、<a href="https://github.com/jcmoraisjr/haproxy-ingress">HAProxy Ingress controller</a>，我们这里选择traefik 作为ingress controller。</p><p>创建RBAC</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br></pre></td></tr></table></figure><p>创建用于存储https证书的secret（不配置https可以省略）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -newkey rsa:2048 -nodes -keyout tls.key -x509 -days 365 -out tls.crt</span><br><span class="line">$ kubectl create secret generic traefik-cert --from-file=tls.crt --from-file=tls.key -n web</span><br></pre></td></tr></table></figure><p>创建名为traefik.toml的Traefik配置文件，并存储到configmap中（不配置https可以省略）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">defaultEntryPoints</span> <span class="string">=</span> [<span class="string">&quot;http&quot;</span>, <span class="string">&quot;https&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">entryPoints</span>]</span><br><span class="line">  [<span class="string">entryPoints.http</span>]</span><br><span class="line">  <span class="string">address</span> <span class="string">=</span> <span class="string">&quot;:80&quot;</span></span><br><span class="line">    [<span class="string">entryPoints.http.redirect</span>]</span><br><span class="line">      <span class="string">entryPoint</span> <span class="string">=</span> <span class="string">&quot;https&quot;</span></span><br><span class="line">  [<span class="string">entryPoints.https</span>]</span><br><span class="line">  <span class="string">address</span> <span class="string">=</span> <span class="string">&quot;:443&quot;</span></span><br><span class="line">    [<span class="string">entryPoints.https.tls</span>]</span><br><span class="line">      [[<span class="string">entryPoints.https.tls.certificates</span>]]</span><br><span class="line">      <span class="string">CertFile</span> <span class="string">=</span> <span class="string">&quot;/ssl/tls.crt&quot;</span></span><br><span class="line">      <span class="string">KeyFile</span> <span class="string">=</span> <span class="string">&quot;/ssl/tls.key&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create configmap traefik-conf --from-file=traefik.toml -n web</span><br></pre></td></tr></table></figure><p>安装traefik</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssl</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">traefik-cert</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">traefik-conf</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">traefik:v1.7.17</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/ssl&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;ssl&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/config&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;config&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--configfile=/config/traefik.toml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--api</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubernetes</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-d</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--logLevel=INFO</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><p>不配置https需要去掉如下配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssl</span></span><br><span class="line">  <span class="attr">secret:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">traefik-cert</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">traefik-conf</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/ssl&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;ssl&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/config&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;config&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">443</span></span><br></pre></td></tr></table></figure><p>创建ingress</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">traefik.haimaxy.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">traefik-ingress-service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p>将 traefik.haimaxy.com 添加到本地hosts解析（因为是svc的暴露方式是NodePort所以要绑定node节点ip），在浏览器中直接访问 traefik.haimaxy.com 正常的话会自动调转至https（未配置https并不会调转）并显示traefik的webui。</p><h1 id="ingress-path配置"><a href="#ingress-path配置" class="headerlink" title="ingress path配置"></a>ingress path配置</h1><p>部署三个简单的web服务</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cnych/example-web-service</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_SVC</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">svc1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">svc2</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cnych/example-web-service</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_SVC</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">svc2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc3</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">svc3</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">cnych/example-web-service</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_SVC</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">svc3</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc3</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc3</span></span><br></pre></td></tr></table></figure><p>创建一个ingress对象访问上面创建的三个服务</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-web-app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;traefik&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.haimaxy.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/s1</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">svc1</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/s2</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">svc2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">svc3</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p>将 example.haimaxy.com 添加到hosts解析（这里svc的类型是ClusterIP，所以要绑定这三个svc中任意一个的ClusterIP。），访问 example.haimaxy.com 测试。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl -k https://example.haimaxy.com/</span><br><span class="line">Hi, I<span class="string">&#x27;m the svc3 service!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ curl -k https://example.haimaxy.com/s1</span></span><br><span class="line"><span class="string">Hi, I&#x27;</span>m the svc1 service!</span><br><span class="line"></span><br><span class="line">$ curl -k https://example.haimaxy.com/s2</span><br><span class="line">Hi, I<span class="string">&#x27;m the svc2 service!</span></span><br></pre></td></tr></table></figure><p>如果需要不同的域名单独配置证书，需要在ingress中添加如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">traefik-cert</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Ingress 相当于负载均衡器的路由配置信息；Ingress controller 可以理解为一个监听器，实时的感知后端 service、pod 的变化，当得到这些变化信息后，Ingress controller 再结合 Ingress 的配置，更新反向代理负载均衡器，达到服务发现的作用。</summary>
    
    
    
    <category term="kubernetes" scheme="https://wangmg-ygxdqp.github.io/categories/kubernetes/"/>
    
    
    <category term="kubernetes.ingress" scheme="https://wangmg-ygxdqp.github.io/tags/kubernetes-ingress/"/>
    
  </entry>
  
  <entry>
    <title>kubectl权限控制</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/07/03/kubectl-20201203/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/07/03/kubectl-20201203/</id>
    <published>2019-07-03T08:39:02.000Z</published>
    <updated>2020-12-03T02:29:08.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>RBAC使用rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC。<a id="more"></a></p><p>RBAC详解：<a href="https://www.qikqiak.com/post/use-rbac-in-k8s/">kubernetes RBAC</a></p><p>Role：定义权限的集合，作用域为namespace<br>ClusterRole：定义权限的集合，作用域为集群<br>RoleBinding：将Role与sa关联<br>ClusterRoleBinding：将ClusterRole与sa关联</p><h2 id="创建一个只读用户"><a href="#创建一个只读用户" class="headerlink" title="创建一个只读用户"></a>创建一个只读用户</h2><p>创建ClusterRole</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mytest-view</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">serviceaccounts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bindings</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">limitranges</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/log</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/exec</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/exec</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets/scale</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cronjobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f clusterrole-mytest-view.yaml</span><br></pre></td></tr></table></figure><p>创建 ServiceAccount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns mytest</span><br><span class="line">$ kubectl create sa -n mytest user-guest</span><br></pre></td></tr></table></figure><p>创建 ClusterRoleBinding</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns mytest</span><br><span class="line">$ kubectl create sa -n mytest user-guest</span><br></pre></td></tr></table></figure><p>创建 ClusterRoleBinding</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mytest:user-guest</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mytest-view</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-guest</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mytest</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f clusterrolebinding-view.yml</span><br></pre></td></tr></table></figure><h2 id="生成kubeconfig文件"><a href="#生成kubeconfig文件" class="headerlink" title="生成kubeconfig文件"></a>生成kubeconfig文件</h2><p>查看token</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ TOKEN=$(kubectl get sa -n mytest user-guest -o go-template=<span class="string">&#x27;&#123;&#123;range .secrets&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$TOKEN</span></span><br></pre></td></tr></table></figure><p>查看cert</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ CA_CERT=$(kubectl get secret -n mytest <span class="variable">$&#123;TOKEN&#125;</span> -o yaml | awk <span class="string">&#x27;/ca.crt:/&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$CA_CERT</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ API_SERVER=<span class="string">&quot;https://10.100.100.127:6443&quot;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$API_SERVER</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SECRET=$(kubectl -n mytest get secret <span class="variable">$&#123;TOKEN&#125;</span> -o go-template=<span class="string">&#x27;&#123;&#123;.data.token&#125;&#125;&#x27;</span>)</span><br><span class="line">kubectl config set-credentials mytest-guest --token=<span class="built_in">echo</span> <span class="variable">$&#123;SECRET&#125;</span> | base64 -d --kubeconfig=guest.config</span><br><span class="line">kubectl config set-context default --cluster=cluster --user=mytest-guest --kubeconfig=guest.config</span><br><span class="line">kubectl config use-context default --kubeconfig=guest.config</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">server:</span>  <span class="comment">#apiserver的地址</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span>  <span class="comment">#cert</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">cluster</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">mytest-guest</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mytest-guest</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">token:</span>  <span class="comment">#token</span></span><br></pre></td></tr></table></figure><p>创建好kubeconfig文件后可以通过这个user-guest这个sa测试，正常的话在删除资源的时候会报错没有delete权限。</p><p>参考文档：<a href="https://www.jianshu.com/p/a1a0d64f1245">kubernetes如何对kubectl做权限管理</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;RBAC&quot;&gt;&lt;a href=&quot;#RBAC&quot; class=&quot;headerlink&quot; title=&quot;RBAC&quot;&gt;&lt;/a&gt;RBAC&lt;/h1&gt;&lt;p&gt;RBAC使用rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC。</summary>
    
    
    
    <category term="kubernetes" scheme="https://wangmg-ygxdqp.github.io/categories/kubernetes/"/>
    
    
    <category term="kubernetes.RBAC" scheme="https://wangmg-ygxdqp.github.io/tags/kubernetes-RBAC/"/>
    
  </entry>
  
  <entry>
    <title>elasticdump导入导出es索引数据</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/06/26/log-20201128/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/06/26/log-20201128/</id>
    <published>2019-06-26T07:51:43.000Z</published>
    <updated>2020-12-02T08:06:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>elasticdump提供了多种导入导出数据的方式，执行的命令也很简单，只需指定数据来源 input 、数据输出 output 、数据类型 type 即可。<a id="more"></a></p><h1 id="通过npm安装elasticdump"><a href="#通过npm安装elasticdump" class="headerlink" title="通过npm安装elasticdump"></a>通过npm安装elasticdump</h1><p>安装nodejs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://nodejs.org/dist/v10.13.0/node-v10.13.0-linux-x64.tar.gz</span><br><span class="line">$ tar xvf node-v10.13.0-linux-x64.tar.gz</span><br><span class="line">$ ln -s ~/node-v10.13.0-linux-x64/bin/node /usr/bin/node</span><br><span class="line">$ ln -s ~/node-v10.13.0-linux-x64/bin/node /usr/bin/node</span><br><span class="line">$ node -v &amp;&amp; npm -v</span><br></pre></td></tr></table></figure><p>安装elasticdump</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br><span class="line">$ npm install elasticdump</span><br><span class="line">$ ln -s ~/node_modules/elasticdump/bin/elasticdump /usr/bin/elasticdump</span><br></pre></td></tr></table></figure><h1 id="导出索引数据"><a href="#导出索引数据" class="headerlink" title="导出索引数据"></a>导出索引数据</h1><p>导出到文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticdump --httpAuthFile=/data/backup/auth.ini --input=http://0.0.0.0:9200/log-2020.04.13 --output=/data/backup/log.json --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><p>–httpAuthFile  #如果es启用了http验证，那么就需要将用户名、密码以ini格式写入文件中。</p><p>导出到压缩包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticdump --httpAuthFile=/data/backup/auth.ini --input=http://0.0.0.0:9200/log-2019.06.13 --output=$ | gzip &gt; /data/backup/log.gz</span><br></pre></td></tr></table></figure><h1 id="导入索引数据"><a href="#导入索引数据" class="headerlink" title="导入索引数据"></a>导入索引数据</h1><p>通过文件导入到es</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ elasticdump --httpAuthFile=/data/backup/auth.ini --output=http:///0.0.0.0:9200/log-2020.06.13 --input=/data/backup/log.json --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure><p>其他详细用法：<a href="https://www.npmjs.com/package/elasticdump">elasticdump-npm</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;elasticdump提供了多种导入导出数据的方式，执行的命令也很简单，只需指定数据来源 input 、数据输出 output 、数据类型 type 即可。</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="elasticdump" scheme="https://wangmg-ygxdqp.github.io/tags/elasticdump/"/>
    
  </entry>
  
  <entry>
    <title>elasticsearch 6.8 启用xpack</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/06/25/log-20201127/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/06/25/log-20201127/</id>
    <published>2019-06-25T02:57:40.000Z</published>
    <updated>2020-12-02T03:13:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>x-pack是一个Elastic Stack扩展，提供了安全、报警、监控等功能，默认情况下6.3版本以上的es在安装的时候已自动安装x-pack<a id="more"></a></p><p>安装x-pack，到es的安装目录下的bin下运行。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">elasticsearch-plugin</span> <span class="string">install</span> <span class="string">x-pack</span></span><br></pre></td></tr></table></figure><p>开启x-pack</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>开启x-pack需要开启ssl，否则启动会报错。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure><p>配置ssl证书，到es的安装目录下的bin下依次执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ elasticsearch-certutil ca</span><br><span class="line">$ elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br></pre></td></tr></table></figure><p>elasticsearch-certutil ca 会生成elastic-stack-ca.p12 这个文件，elasticsearch-certutil cert –ca elastic-stack-ca.p12 会生成 elastic-certificates.p12 ，elastic-certificates.p12 就是我们需要的证书。</p><p>添加如下配置（根据你自己的环境指定证书路径）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br></pre></td></tr></table></figure><p>如果使用head插件，需要添加如下配置。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">http.cors.allow-headers:</span> <span class="string">Authorization,X-Requested-With,Content-Length,Content-Type</span></span><br></pre></td></tr></table></figure><p>由于开后x-pack后需要认证，所以head的访问格式也有变化。</p><pre><code>http://head.host:9100/?auth_user=user&amp;auth_password=passwd</code></pre><p>auth_user=用户名，auth_password=密码。</p><p>开启x-pack后es的内置用户会存储在.security索引中，我们需要生成这个索引;到es的安装目录下的bin下运行。（如果误删了.security索引，需要停止es服务安照如下步骤操作）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ elasticsearch-keystore create</span><br><span class="line">$ elasticsearch-setup-passwords interactive</span><br></pre></td></tr></table></figure><p>elastic用户拥有最高权限，可以使用这个用户在kibana上创建用户。</p><p>es开启x-pack后kibana需要认证，在kibana.yaml中添加如下配置。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;kibana&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;your_password&quot;</span></span><br></pre></td></tr></table></figure><p>logstash 同样需要认证，以下为output中的配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch &#123;</span><br><span class="line">      hosts &#x3D;&gt; [&quot;host1:9200&quot;]</span><br><span class="line">      index &#x3D;&gt; [&quot;name-%&#123;+YYYY.MM.dd&#125;&quot;]</span><br><span class="line">      user &#x3D;&gt; &quot;logstash&quot;</span><br><span class="line">      password &#x3D;&gt; &quot;your_password&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>es完整的配置如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">ELK</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">elk-1</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/dir/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/dir/log/elasticsearch</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;host1&quot;</span>, <span class="string">&quot;host2&quot;</span>]</span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/dir/cert/elastic-certificates.p12</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">http.cors.allow-headers:</span> <span class="string">Authorization,X-Requested-With,Content-Length,Content-Type</span></span><br></pre></td></tr></table></figure><p>参考文档：<a href="https://tianmingxing.com/2019/06/20/%E5%9C%A8ElasticSearch6.8%E5%8F%8A%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E5%BC%80%E5%90%AF%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD">es集群加密认证</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;x-pack是一个Elastic Stack扩展，提供了安全、报警、监控等功能，默认情况下6.3版本以上的es在安装的时候已自动安装x-pack</summary>
    
    
    
    <category term="ELK" scheme="https://wangmg-ygxdqp.github.io/categories/ELK/"/>
    
    
    <category term="kibana" scheme="https://wangmg-ygxdqp.github.io/tags/kibana/"/>
    
    <category term="elasticsearch" scheme="https://wangmg-ygxdqp.github.io/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes删除namespace一直处于Terminating状态</title>
    <link href="https://wangmg-ygxdqp.github.io/2019/06/15/kubernetes-20201215/"/>
    <id>https://wangmg-ygxdqp.github.io/2019/06/15/kubernetes-20201215/</id>
    <published>2019-06-15T07:47:25.000Z</published>
    <updated>2020-12-15T08:10:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>尝试通过 –force –grace-period=0 强制删除的方式删除报错： Error from server (Conflict): Operation cannot be fulfilled on namespaces “logging”: The system is ensuring all content is removed from this namespace. Upon completion, this namespace will automatically be purged by the system.<a id="more"></a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ns</span><br><span class="line">logging  Terminating  32d</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete namespace logging --force --grace-period=0</span><br><span class="line">Error from server (Conflict): Operation cannot be fulfilled on namespaces <span class="string">&quot;logging&quot;</span>: The system is ensuring all content is removed from this namespace. Upon completion, this namespace will automatically be purged by the system.</span><br></pre></td></tr></table></figure><p>强制删除也不行，在网上找到了一个方法。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get namespace logging -o json &gt; tmp.json</span><br><span class="line">$ kubectl proxy --port=8081</span><br><span class="line">$ curl -k -H <span class="string">&quot;Content-Type: application/json&quot;</span> -X PUT --data-binary @tmp.json http://127.0.0.1:8081/api/v1/namespaces/logging/finalize</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Namespace&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;logging&quot;</span>,</span><br><span class="line">    <span class="string">&quot;selfLink&quot;</span>: <span class="string">&quot;/api/v1/namespaces/logging/finalize&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uid&quot;</span>: <span class="string">&quot;e6e66a5c-257b-11eb-90f4-000c2975fe6e&quot;</span>,</span><br><span class="line">    <span class="string">&quot;resourceVersion&quot;</span>: <span class="string">&quot;609429&quot;</span>,</span><br><span class="line">    <span class="string">&quot;creationTimestamp&quot;</span>: <span class="string">&quot;2020-11-13T06:46:04Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;deletionTimestamp&quot;</span>: <span class="string">&quot;2020-12-15T06:42:01Z&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;spec&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;phase&quot;</span>: <span class="string">&quot;Terminating&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功删除的话会返回上面的信息，“kubectl proxy –port=8081”是为了将我的apiserver映射到8081，因为我的apiserver没有开启非安全端口（apiserver安全端口访问需要通过证书验证，否则会报错401。如果想通过浏览器访问apiserver的安全端口：<a href="https://my.oschina.net/u/4313588/blog/3511527">浏览器访问 kube-apiserver 安全端口</a>）。</p><p>参考文档：<a href="https://github.com/kubernetes/kubernetes/issues/19317">Kubernetes namespaces stuck in terminating state</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;尝试通过 –force –grace-period=0 强制删除的方式删除报错： Error from server (Conflict): Operation cannot be fulfilled on namespaces “logging”: The system is ensuring all content is removed from this namespace. Upon completion, this namespace will automatically be purged by the system.</summary>
    
    
    
    <category term="kubernetes" scheme="https://wangmg-ygxdqp.github.io/categories/kubernetes/"/>
    
    
    <category term="kubernetes.namespace" scheme="https://wangmg-ygxdqp.github.io/tags/kubernetes-namespace/"/>
    
  </entry>
  
</feed>
